{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Календарь" %} - {% trans "Школа" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{% trans "Календарь" %}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if user.is_methodist %}
        <div class="btn-group me-2">
            <a href="{% url 'scheduling:lesson_create' %}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus"></i> {% trans "Запланировать занятие" %}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Week Navigation -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="?week={{ prev_week }}" class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-1">
                        <i class="bi bi-chevron-left"></i> {% trans "Предыдущая неделя" %}
                    </a>
                    
                    <div class="text-center">
                        <h5 class="mb-0">
                            {% if is_current_week %}
                                {% trans "Текущая неделя" %}
                            {% else %}
                                {% trans "Неделя" %}
                            {% endif %}
                        </h5>
                        <small class="text-muted">
                            {{ week_start|date:"d.m.Y" }} - {{ week_end|date:"d.m.Y" }}
                        </small>
                    </div>
                    
                    <a href="?week={{ next_week }}" class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-1">
                        {% trans "Следующая неделя" %} <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weekly Calendar Grid with time gutter -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">{% if user.is_student %}Ваши занятия{% elif user.is_teacher %}Ваше расписание{% else %}Все занятия{% endif %}</h5>
      </div>
      <div class="card-body p-0">
        <div class="weekly-calendar">
          <div class="time-gutter"><div class="time-gutter-inner"></div></div>
          <div class="days-grid">
            {% for day_date, day_lessons in lessons_by_day.items %}
            <div class="day-column">
              <div class="day-header">
                <div class="day-name">
                  {% if day_date|date:"Y-m-d" == today|date:"Y-m-d" %}<strong class="text-primary">{{ day_date|date:"l" }}</strong>{% else %}{{ day_date|date:"l" }}{% endif %}
                </div>
                <div class="day-date">{{ day_date|date:"d.m" }}</div>
              </div>
              <div class="day-lessons" data-day="{{ day_date|date:'Y-m-d' }}">
                {% for lesson in day_lessons %}
                <div class="lesson-item {% if lesson.start_time|date:"Y-m-d" == today|date:"Y-m-d" %}today{% endif %}"
                     data-id="{{ lesson.id }}" data-start="{{ lesson.start_time|date:'c' }}" data-end="{{ lesson.end_time|date:'c' }}"
                     onclick="showLessonDetails({{ lesson.id }})">
                  <div class="lesson-title">{{ lesson.title|truncatewords:3 }}</div>
                  <div class="lesson-time">{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</div>
                </div>
                {% empty %}
                <div class="no-lessons text-muted text-center p-3"><i class="bi bi-calendar-x"></i><small>{% trans "Нет занятий" %}</small></div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating live lesson card -->
<div id="liveLessonCard" class="live-lesson-card d-none" aria-live="polite">
  <div class="ll-header">Занятие началось</div>
  <div class="ll-body"><div class="ll-title" id="llTitle">—</div><div class="ll-time text-muted" id="llTime">—</div></div>
  <div class="ll-actions"><a id="llJoin" class="btn btn-success btn-sm disabled" href="#" target="_blank" rel="noopener">Присоединиться</a><button id="llDismiss" class="btn btn-outline-secondary btn-sm">Скрыть</button></div>
</div>

<!-- Lesson Details Modal -->
<div class="modal fade" id="lessonDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Информация о занятии</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Закрыть' %}"></button>
            </div>
            <div class="modal-body" id="lessonDetailsContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
  :root { --gutter-w: 60px; --ppm: 1; --gutter-offset: 84px; }
  .weekly-calendar { display: grid; grid-template-columns: var(--gutter-w) 1fr; }
  .time-gutter { position: relative; border-right: 1px solid #e9ecef; background:#fff; }
  .time-gutter-inner { position: relative; }
  .time-tick { position: absolute; left: 0; right: 0; height: 0; border-top: 1px solid rgba(30,41,59,.18); }
  .time-tick .label { position: absolute; right: 6px; top: -8px; font-size: .72rem; color:#64748b; background:#fff; padding:0 2px; font-weight: normal; }
  .time-tick.last { border-top: 1px solid rgba(30,41,59,.18); }
  .time-tick.last .label { font-weight: normal; color: #64748b; top: -8px; }
  .time-subtick { position: absolute; left: 0; right: 0; height: 0; border-top: 1px dashed rgba(30,41,59,.10); }
  .time-gutter-inner { min-height: calc(24*60px + 40px); }

  .days-grid { display: grid; grid-template-columns: repeat(7,1fr); gap:1px; background:#e9ecef; }
  .day-column { background:#fff; display:flex; flex-direction:column; }
  .day-header { padding: 15px 10px; background:#f8f9fa; border-bottom:1px solid #e9ecef; text-align:center; position:sticky; top:0; z-index:10; }
  .day-name { font-weight:500; font-size:.9rem; margin-bottom:5px; }
  .day-date { font-size:1.1rem; font-weight:bold; color:#495057; }
  .day-lessons { position:relative; padding:12px; overflow:visible; background-image:
      repeating-linear-gradient(to bottom, rgba(30,41,59,.18) 0, rgba(30,41,59,.18) 1px, transparent 1px, transparent 60px),
      repeating-linear-gradient(to bottom, rgba(30,41,59,.10) 0, rgba(30,41,59,.10) 1px, transparent 1px, transparent 30px);
    background-size:100% 60px, 100% 30px; background-position: 0 0, 0 0; background-repeat:repeat; }
  /* Восстановлены исходные размеры карточек уроков */
  .lesson-item { position:absolute; left:6px; right:6px; background:#f9f9fa; border:1px solid #e9ecef; border-left:4px solid #94a3b8; border-radius:6px; padding:6px 8px; cursor:pointer; transition: box-shadow .2s, transform .12s; z-index:2; font-size:0.92rem; display:flex; flex-direction:column; gap:4px; }
  .lesson-item:hover { box-shadow:0 2px 6px rgba(0,0,0,.08); }
  .lesson-item.in-progress {
    border-left: 6px solid #22c55e;
    background: linear-gradient(90deg, #e6f7c9 80%, #f7fee7 100%);
    box-shadow: 0 4px 16px rgba(34,197,94,0.18);
    /* keep absolute positioning so top/left computed by JS remain valid */
    position: absolute;
    z-index: 10;
    animation: pulse-inprogress 1.2s infinite alternate;
  }
  @keyframes pulse-inprogress {
    0% { box-shadow: 0 4px 16px rgba(34,197,94,0.18); }
    100% { box-shadow: 0 0px 24px 4px rgba(34,197,94,0.28); }
  }
  .lesson-title { font-weight:600; font-size:.90rem; margin-bottom:2px; line-height:1.22; }
  .lesson-time { font-size:.78rem; font-weight:500; color:#6c757d; }
  .now-line { position:absolute; left:0; right:0; height:2px; background:#dc3545; z-index:10000; pointer-events: none; }
  /* кружок теперь ровно на границе колонки */
  .now-line::after { content:""; position:absolute; left:0; top:-4px; width:8px; height:8px; border-radius:50%; background:#dc3545; transform: translateX(-50%); }

  .live-lesson-card { position:fixed; right:16px; bottom:16px; width:320px; max-width:calc(100vw - 32px); background:#fff; border:1px solid #e7ecf3; border-radius:12px; box-shadow:0 10px 30px rgba(16,24,40,.16); z-index:1050; }
  .live-lesson-card .ll-header { padding:10px 12px; font-weight:600; border-bottom:1px solid #eef2f7; }
  .live-lesson-card .ll-body { padding:10px 12px; }
  .live-lesson-card .ll-title { font-weight:600; margin-bottom:2px; }
  .live-lesson-card .ll-actions { padding:10px 12px; border-top:1px solid #eef2f7; display:flex; gap:8px; justify-content:flex-end; }
  .d-none { display:none !important; }

  .details-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    margin-bottom: 12px;
  }
  .section-block {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px 18px;
    flex: 1 1 320px;
    min-width: 220px;
    margin-bottom: 8px;
    box-shadow: 0 2px 8px rgba(30,41,59,0.04);
  }
  .section-title {
    font-weight: 600;
    font-size: 1.08rem;
    margin-bottom: 8px;
    color: #334155;
  }
  .section-block p {
    margin-bottom: 6px;
    font-size: 0.98rem;
  }
  .section-block strong {
    color: #475569;
  }
  .section-block .btn {
    margin-top: 8px;
  }
  .modal-body .section-block:last-child {
    margin-bottom: 0;
  }

  @media (max-width:768px){ :root{ --gutter-w:52px; } .days-grid{ grid-template-columns:1fr; gap:10px; } .day-header{ position:relative; display:flex; justify-content:space-between; align-items:center; text-align:left; } }
</style>
<script>
(function(){
  const PPM = 1; // px per minute
  const MIN_LESSON_PX = 16; // минимальная высота карточки
  const GUTTER_OFFSET = 84; // увеличенный фиксированный отступ для таймлайна (ещё на 1px ниже)
  const todayStr = '{{ today|date:"Y-m-d" }}';
  let liveCardLessonId = null;

  function ensureGutter(offset){
    const inner = document.querySelector('.time-gutter-inner');
    if(!inner) return;
    inner.style.height = String(offset + 24*60*PPM + 20) + 'px';
    inner.innerHTML = '';
    for (let h=0; h<=24; h++){
      const top = offset + h*60*PPM;
      const tick = document.createElement('div');
      tick.className = 'time-tick' + (h === 24 ? ' last' : '');
      tick.style.top = top + 'px';
      const label = document.createElement('div');
      label.className = h === 24 ? 'label last' : 'label';
      label.textContent = String(h).padStart(2,'0') + ':00';
      tick.appendChild(label);
      inner.appendChild(tick);
      if (h < 24 && h < 23){
        const subtick = document.createElement('div');
        subtick.className = 'time-subtick';
        subtick.style.top = (offset + h*60*PPM + 30*PPM) + 'px';
        inner.appendChild(subtick);
      }
    }
  }

  function layoutDayColumns(offset){
    document.querySelectorAll('.day-lessons').forEach(function(col){
      col.style.height = String(24*60*PPM) + 'px';
      const day = col.getAttribute('data-day');
      const oldLine = col.querySelector('.now-line');
      if (oldLine) oldLine.remove();
      const items = Array.from(col.querySelectorAll('.lesson-item'));
      const placed = [];
      items.forEach(function(it){
        const startISO = it.getAttribute('data-start');
        const endISO = it.getAttribute('data-end');
        if (!startISO || !endISO) return;
        const s = new Date(startISO); const e = new Date(endISO);
        const dayStart = new Date(s.getFullYear(), s.getMonth(), s.getDate(), 0,0,0,0);
        const top = Math.max(0, Math.round((s - dayStart)/60000) * PPM);
        const h = Math.max(MIN_LESSON_PX, Math.round((e - s)/60000) * PPM);
        it.style.top = top + 'px';
        it.style.height = h + 'px';
        // use transform to shift horizontally on overlap — preserves absolute top and prevents layout shifts
        let shift = 0;
        for (const p of placed){ const pt = p.top, ph = p.h; if (!(top >= pt+ph || (top+h) <= pt)) { shift += 6; } }
        it.style.left = '6px';
        // don't shift currently in-progress lesson cards — keep them fixed to their computed position
        if (it.classList.contains('in-progress')) {
          it.style.transform = 'none';
        } else {
          if (shift) { it.style.transform = `translateX(${shift}px)`; } else { it.style.transform = 'none'; }
        }
         placed.push({top: top, h: h});
        const now = new Date();
        if (now >= s && now <= e) it.classList.add('in-progress'); else it.classList.remove('in-progress');
      });
      // Now line только для сегодняшнего дня
      if (day === todayStr){
        const now = new Date();
        const dayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
        const y = Math.max(0, Math.min(24*60*PPM, Math.round((now - dayStart)/60000) * PPM));
        const line = document.createElement('div'); line.className = 'now-line'; line.style.top = y + 'px'; col.appendChild(line);
      }
    });
    // Gutter
    ensureGutter(offset);
  }

  async function fetchLessonDetails(id){
    const lang = '{{ request.LANGUAGE_CODE|default:"ru" }}';
    try{ const r = await fetch(`/${lang}/scheduling/lessons/${id}/details/`, { headers:{ 'Accept':'application/json' } }); if(!r.ok) return null; return await r.json(); }catch(e){ return null; }
  }

  function enableJoinButton(btn, infoSpan, startISO, endISO, link){
    const s = new Date(startISO), e = new Date(endISO), now = new Date();
    const windowOpen = new Date(s.getTime()-5*60000);
    if (now >= windowOpen && now <= e){ btn.classList.remove('disabled'); btn.href = link; btn.title = 'Присоединиться к занятию'; if (infoSpan) infoSpan.textContent = ''; }
    else { btn.classList.add('disabled'); btn.removeAttribute('href'); if (infoSpan) infoSpan.textContent = now < windowOpen ? 'Доступно за 5 минут до начала.' : 'Занятие завершено.'; }
  }

  async function updateLiveLessonCard(){
    const card = document.getElementById('liveLessonCard'); if(!card) return;
    const snoozeUntil = Number(sessionStorage.getItem('llSnoozeUntil')||0); if (Date.now() < snoozeUntil){ card.classList.add('d-none'); return; }
    const todayCol = document.querySelector(`.day-lessons[data-day="${todayStr}"]`); if(!todayCol){ card.classList.add('d-none'); return; }
    const current = todayCol.querySelector('.lesson-item.in-progress'); if(!current){ card.classList.add('d-none'); liveCardLessonId = null; return; }
    const id = current.getAttribute('data-id'); const title = (current.querySelector('.lesson-title')?.textContent || '').trim(); const timeText = (current.querySelector('.lesson-time')?.textContent || '').trim();
    let details = null; if (liveCardLessonId !== id){ details = await fetchLessonDetails(id); liveCardLessonId = id; card.dataset.startIso = details?.start_iso || ''; card.dataset.endIso = details?.end_iso || ''; card.dataset.link = details?.zoom_link || ''; }
    else { details = { start_iso: card.dataset.startIso, end_iso: card.dataset.endIso, zoom_link: card.dataset.link }; }
    document.getElementById('llTitle').textContent = title || 'Занятие'; document.getElementById('llTime').textContent = timeText || ''; const joinBtn = document.getElementById('llJoin'); enableJoinButton(joinBtn, null, details.start_iso, details.end_iso, details.zoom_link || '#');
    if (details.zoom_link){ card.classList.remove('d-none'); } else { card.classList.add('d-none'); }
  }

  function wireLiveCard(){ const dismissBtn = document.getElementById('llDismiss'); if (dismissBtn){ dismissBtn.addEventListener('click', function(){ const until = Date.now() + 30*60*1000; sessionStorage.setItem('llSnoozeUntil', String(until)); document.getElementById('liveLessonCard').classList.add('d-none'); }); } }

  function recalc(){
    layoutDayColumns(GUTTER_OFFSET);
    updateLiveLessonCard();
  }

  document.addEventListener('DOMContentLoaded', function(){ wireLiveCard(); recalc(); setInterval(function(){ layoutDayColumns(GUTTER_OFFSET); updateLiveLessonCard(); }, 60000); });
  window.addEventListener('resize', function(){ recalc(); });
})();

function showLessonDetails(lessonId){
  const lang = '{{ request.LANGUAGE_CODE|default:"ru" }}';
  const modal = new bootstrap.Modal(document.getElementById('lessonDetailsModal'));
  const content = document.getElementById('lessonDetailsContent');
  content.innerHTML = '<div class="text-center text-muted py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
  modal.show();
  fetch(`/${lang}/scheduling/lessons/${lessonId}/details/`, { headers: { 'Accept':'application/json' }})
    .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
    .then(data => {
      // helper to escape HTML
      function escapeHTML(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>\"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[m]; }); }

      const title = escapeHTML(data.title || '');
      const subject = escapeHTML(data.subject || '');
      const date = escapeHTML(data.date || '');
      const start = escapeHTML(data.start_time || '');
      const end = escapeHTML(data.end_time || '');
      const teacher = escapeHTML(data.teacher || '');
      const student = escapeHTML(data.student || '');
      const description = escapeHTML(data.description || '');
      const zoomHref = data.zoom_link ? encodeURI(data.zoom_link) : '';

      const html = `
        <div class="details-grid">
          <div class="section-block">
            <div class="section-title">Основная информация</div>
            <p><strong>Название:</strong> ${title}</p>
            <p><strong>Предмет:</strong> ${subject}</p>
            <p><strong>Дата:</strong> ${date}</p>
            <p><strong>Время:</strong> ${start} - ${end}</p>
          </div>
          <div class="section-block">
            <div class="section-title">Участники</div>
            ${teacher ? `<p><strong>Преподаватель:</strong> ${teacher}</p>` : ''}
            ${student ? `<p><strong>Ученик:</strong> ${student}</p>` : ''}
            <div class="mt-3 d-flex align-items-center gap-2">
              ${zoomHref ? `<a id="joinLessonBtnModal" class="btn btn-success disabled" href="#" data-start="${escapeHTML(data.start_iso)}" data-end="${escapeHTML(data.end_iso)}" data-link="${zoomHref}">Подключиться</a>` : ''}
            </div>
          </div>
        </div>
        ${description ? `<div class="section-block"><div class="section-title">Описание</div><p>${description}</p></div>` : ''}
      `;
      content.innerHTML = html;
      (function(){ const btn = document.getElementById('joinLessonBtnModal'); if(!btn) return; function update(){ const s = new Date(btn.getAttribute('data-start')); const e = new Date(btn.getAttribute('data-end')); const now = new Date(); const open = new Date(s.getTime()-5*60000); if (now >= open && now <= e){ btn.classList.remove('disabled'); btn.href = btn.getAttribute('data-link'); btn.title = 'Присоединиться к занятию'; } else { btn.classList.add('disabled'); btn.removeAttribute('href'); btn.title = now < open ? 'Доступно за 5 минут до начала' : 'Занятие завершено'; } } update(); setInterval(update, 30000); })();
    })
    .catch(() => { content.innerHTML = '<div class="alert alert-danger">Ошибка при загрузке данных занятия</div>'; });
}
</script>
{% endblock %}
