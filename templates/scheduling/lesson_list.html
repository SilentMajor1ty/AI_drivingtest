{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Занятия" %} - {% trans "Школа" %}{% endblock %}

{% block sidebar_admin_header %}{% endblock %}

{% block content %}
<style>
  .title-icon { height: 1em; width: auto; vertical-align: -0.12em; }
  .icon { height: 1em; width: auto; vertical-align: -0.15em; }
  /* Design polish for lessons */
  .nav-pills .nav-link { border-radius: 10px; }
  .nav-pills .nav-link.active { box-shadow: 0 2px 8px rgba(13,110,253,.15); }
  .card { border: 1px solid #e7ecf3; border-radius: 14px; box-shadow: 0 4px 16px rgba(16,24,40,.06); }
  .card-header { background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%); border-bottom: 1px solid #e9edf5; }
  .table tbody tr:hover { background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); }
  .badge { vertical-align: middle; }
  .clickable-row { cursor: pointer; }
  .clickable-row .btn { cursor: default; }
  /* Filter card */
  .filter-card .card-body { background: linear-gradient(180deg, #f8fafc 0%, #eef3f9 100%); border: 1px solid #e6ebf2; border-radius: 12px; }
  .filter-card .form-select { border-radius: 10px; border-color:#d7deea; }
  .filter-card .form-select:focus { border-color:#9bb7ff; box-shadow: 0 0 0 .2rem rgba(13,110,253,.12); }
  /* Details modal layout */
  #lessonDetailsContent { line-height: 1.55; }
  #lessonDetailsContent p { margin-bottom: .5rem; }
  .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
  .section-block { background:#f8fafc; border:1px solid #e7ecf3; border-radius: 10px; padding: 12px 14px; }
  .section-title { font-weight: 600; margin-bottom: .5rem; }
  @media (max-width: 768px){ .details-grid { grid-template-columns: 1fr; } }

  .btn-outline-primary.btn-xs {
    transition: background 0.18s, color 0.18s;
    font-size: 0.9rem;
    border-radius: 6px;
    min-width: 28px;
    padding: 2px 8px;
    line-height: 1.2;
  }
  .btn-outline-primary.btn-xs:hover, .btn-outline-primary.btn-xs:focus {
    background: #0d6efd !important;
    color: #fff !important;
    border-color: #0d6efd !important;
  }
  .btn-outline-primary.btn-xs i {
    color: #0d6efd;
    font-size: 0.85rem;
    transition: color 0.18s;
  }
  .btn-outline-primary.btn-xs:hover i, .btn-outline-primary.btn-xs:focus i {
    color: #fff !important;
  }
  .btn-outline-danger.btn-xs {
    transition: background 0.18s, color 0.18s;
    font-size: 0.9rem;
    border-radius: 6px;
    min-width: 28px;
    padding: 2px 8px;
    line-height: 1.2;
    border-color: #dc3545;
    color: #dc3545;
    background: #fff;
  }
  .btn-outline-danger.btn-xs:hover, .btn-outline-danger.btn-xs:focus {
    background: #dc3545 !important;
    color: #fff !important;
    border-color: #dc3545 !important;
  }
  .btn-outline-danger.btn-xs i {
    color: #dc3545;
    font-size: 0.85rem;
    transition: color 0.18s;
  }
  .btn-outline-danger.btn-xs:hover i, .btn-outline-danger.btn-xs:focus i {
    color: #fff !important;
  }
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">{% trans "Занятия" %}</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    {% if user.is_methodist %}
    <div class="btn-group me-2">
      <a href="{% url 'scheduling:lesson_create' %}" class="btn btn-sm btn-primary">
        <img src="https://img.icons8.com/fluency/20/plus-math.png" alt="" class="icon me-1"/> {% trans "Запланировать занятие" %}
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Tabs: Upcoming / Completed -->
<ul class="nav nav-pills mb-3">
  <li class="nav-item">
    <a class="nav-link {% if current_tab == 'upcoming' %}active{% endif %}" href="?tab=upcoming{% if selected_teacher %}&teacher={{ selected_teacher }}{% endif %}">{% trans "Предстоящие" %}</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if current_tab == 'all' %}active{% endif %}" href="?tab=all{% if selected_teacher %}&teacher={{ selected_teacher }}{% endif %}">{% trans "Завершенные" %}</a>
  </li>
</ul>

{% if user.is_methodist and teachers %}
<div class="card mb-3 filter-card">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-center" id="lessons-filter-form">
      <input type="hidden" name="tab" value="{{ current_tab|default:'upcoming' }}">
      <div class="col-12 col-md-4">
        <label class="form-label mb-1 small">{% trans "Преподаватель" %}</label>
        <select name="teacher" class="form-select form-select-sm" aria-label="{% trans 'Фильтр по преподавателю' %}">
          <option value="">{% trans "Все преподаватели" %}</option>
          {% for t in teachers %}
            <option value="{{ t.id }}" {% if selected_teacher == t.id %}selected{% endif %}>{{ t.full_name }}</option>
          {% endfor %}
        </select>
      </div>
    </form>
  </div>
</div>
{% endif %}

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      {% if current_tab == 'upcoming' %}{% trans "Предстоящие занятия" %}{% else %}{% trans "Завершенные занятия" %}{% endif %}
    </h5>
    <span class="badge bg-primary">{{ active_lessons|length }}</span>
  </div>
  <div class="card-body">
    {% if active_lessons %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>{% trans "Дата/Время" %}</th>
            {% if user.is_methodist %}
            <th>{% trans "Преподаватель" %}</th>
            <th>{% trans "Ученик" %}</th>
            {% elif user.is_teacher %}
            <th>{% trans "Ученик" %}</th>
            {% else %}
            <th>{% trans "Преподаватель" %}</th>
            {% endif %}
            <th>{% trans "Предмет" %}</th>
            {% if user.is_methodist and current_tab == 'upcoming' %}
              <th>{% trans "Действия" %}</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for lesson in active_lessons %}
          <tr class="clickable-row" onclick="viewLessonDetails({{ lesson.pk }})">
            <td>
              <div class="fw-bold">{{ lesson.start_time|date:"d.m.Y" }}</div>
              <small class="text-muted">{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</small>
            </td>
            {% if user.is_methodist %}
            <td>{{ lesson.teacher.full_name }}</td>
            <td>{{ lesson.student.full_name }}</td>
            {% elif user.is_teacher %}
            <td>{{ lesson.student.full_name }}</td>
            {% else %}
            <td>{{ lesson.teacher.full_name }}</td>
            {% endif %}
            <td>{{ lesson.subject.name }}</td>
            {% if user.is_methodist and current_tab == 'upcoming' %}
            <td>
              <div class="btn-group btn-group-sm" onclick="event.stopPropagation()">
                <button type="button" class="btn btn-outline-primary btn-xs px-2 py-1" title="Перенести" onclick="event.stopPropagation(); rescheduleLesson({{ lesson.pk }})">
                  <i class="bi bi-arrow-repeat" style="font-size:0.85rem;"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-xs px-2 py-1" title="Отменить" onclick="event.stopPropagation(); cancelLesson({{ lesson.pk }})">
                  <i class="bi bi-x-circle" style="font-size:0.85rem;"></i>
                </button>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-4">
      <img src="https://img.icons8.com/fluency/36/journal.png" class="mb-2" alt=""/>
      <div class="mt-2 text-muted">{% trans "Нет данных для отображения" %}</div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Lesson Details Modal -->
<div class="modal fade" id="lessonDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Информация о занятии</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Закрыть' %}"></button>
      </div>
      <div class="modal-body" id="lessonDetailsContent">
        <div class="text-center text-muted py-4">
          <div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Закрыть" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- Reschedule Modal -->
<div class="modal fade" id="rescheduleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Перенести занятие" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Закрыть' %}"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="reschedule-lesson-id">
        <div class="mb-3">
          <label for="new_start_date" class="form-label">{% trans "Новая дата" %}</label>
          <input type="date" class="form-control" id="new_start_date" required>
        </div>
        <div class="mb-3">
          <label for="new_start_time" class="form-label">{% trans "Новое время" %}</label>
          <input type="time" class="form-control" id="new_start_time" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Отмена" %}</button>
        <button type="button" class="btn btn-warning" onclick="submitReschedule()">{% trans "Перенести" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "Отменить занятие" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Закрыть' %}"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="cancel-lesson-id">
        <div class="mb-3">
          <label for="cancel_reason" class="form-label">{% trans "Причина отмены (необязательно)" %}</label>
          <textarea class="form-control" id="cancel_reason" rows="3" placeholder="{% trans 'Укажите причину отмены занятия...' %}"></textarea>
        </div>
        <div class="alert alert-warning">{% trans "Ученик и преподаватель получат уведомления об отмене занятия." %}</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Отмена" %}</button>
        <button type="button" class="btn btn-danger" onclick="submitCancel()">{% trans "Отменить занятие" %}</button>
      </div>
    </div>
  </div>
</div>

<script>
const baseUrl = '/{{ request.LANGUAGE_CODE|default:"ru" }}/scheduling/lessons/';

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function rescheduleLesson(lessonId) {
  document.getElementById('reschedule-lesson-id').value = lessonId;
  new bootstrap.Modal(document.getElementById('rescheduleModal')).show();
}

function cancelLesson(lessonId) {
  document.getElementById('cancel-lesson-id').value = lessonId;
  new bootstrap.Modal(document.getElementById('cancelModal')).show();
}

function submitReschedule() {
  const id = document.getElementById('reschedule-lesson-id').value;
  const newDate = document.getElementById('new_start_date').value;
  const newTime = document.getElementById('new_start_time').value;
  if (!newDate || !newTime) { alert('Укажите дату и время'); return; }
  const fd = new FormData();
  fd.append('new_start_date', newDate);
  fd.append('new_start_time', newTime);
  fetch(`${baseUrl}${id}/reschedule/`, { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCookie('csrftoken') }})
    .then(r => r.json()).then(d => d.success ? location.reload() : alert('Ошибка переноса: ' + d.error))
    .catch(() => alert('Произошла ошибка при переносе занятия'));
}

function submitCancel() {
  const id = document.getElementById('cancel-lesson-id').value;
  const fd = new FormData();
  fd.append('reason', document.getElementById('cancel_reason').value || '');
  fetch(`${baseUrl}${id}/cancel/`, { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCookie('csrftoken') }})
    .then(r => r.json()).then(d => d.success ? location.reload() : alert('Ошибка отмены: ' + d.error))
    .catch(() => alert('Произошла ошибка при отмене занятия'));
}

function mapStatusToBadge(code) {
  switch (code) {
    case 'scheduled': return 'primary';
    case 'rescheduled': return 'warning';
    case 'completed': return 'success';
    case 'cancelled': return 'danger';
    default: return 'secondary';
  }
}

// escape helper to prevent XSS
function escapeHTML(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; }); }

function viewLessonDetails(lessonId) {
  const modal = new bootstrap.Modal(document.getElementById('lessonDetailsModal'));
  const content = document.getElementById('lessonDetailsContent');
  content.innerHTML = '<div class="text-center text-muted py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
  modal.show();

  fetch(`/scheduling/lessons/${lessonId}/details/`, { headers: { 'Accept': 'application/json' }})
    .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
    .then(data => {
      const title = escapeHTML(data.title || '');
      const subject = escapeHTML(data.subject || '');
      const date = escapeHTML(data.date || '');
      const start = escapeHTML(data.start_time || '');
      const end = escapeHTML(data.end_time || '');
      const zoom = data.zoom_link || '';
      const teacher = escapeHTML(data.teacher || '');
      const student = escapeHTML(data.student || '');
      const materials = data.materials || null;
      const teacherMaterials = data.teacher_materials || null;

      let participantsHtml = '';
      if (teacher) participantsHtml += `<p><strong>Преподаватель:</strong> ${teacher}</p>`;
      if (student) participantsHtml += `<p><strong>Ученик:</strong> ${student}</p>`;

      let materialsHtml = '';
      if (materials || teacherMaterials) {
        materialsHtml += '<div class="section-block mt-3"><div class="section-title">Материалы</div>';
        if (materials) {
          materialsHtml += `
            <div class="mb-2 d-flex align-items-center justify-content-between flex-wrap">
              <span>${escapeHTML(materials.name || '')}</span>
              <a href="${materials.url ? encodeURI(materials.url) : '#'}" class="btn btn-sm btn-outline-primary" download>Скачать</a>
              <div class="w-100 text-muted small mt-1">Общие материалы</div>
            </div>`;
        }
        if (teacherMaterials) {
          materialsHtml += `
            <div class="mb-2 d-flex align-items-center justify-content-between flex-wrap">
              <span>${escapeHTML(teacherMaterials.name || '')}</span>
              <a href="${teacherMaterials.url ? encodeURI(teacherMaterials.url) : '#'}" class="btn btn-sm btn-outline-warning" download>Скачать</a>
              <div class="w-100 text-muted small mt-1">Материалы для преподавателя</div>
            </div>`;
        }
        materialsHtml += '</div>';
      }

      let joinButtonHtml = '';
      if (zoom && data.start_iso && data.end_iso) {
        joinButtonHtml = `
          <a id="joinLessonBtnModal" class="btn btn-success disabled" href="#"
             data-start="${escapeHTML(data.start_iso)}" data-end="${escapeHTML(data.end_iso)}" data-link="${encodeURI(zoom)}" title="Доступно за 5 минут до начала">
            Подключиться
          </a>
          <span id="joinLessonInfoModal" class="text-muted ms-2" style="font-size:0.9em;"></span>`;
      }

      content.innerHTML = `
        <div class="details-grid">
          <div class="section-block">
            <div class="section-title">Основная информация</div>
            <p><strong>Название:</strong> ${title}</p>
            <p><strong>Предмет:</strong> ${subject}</p>
            <p><strong>Дата:</strong> ${date}</p>
            <p><strong>Время:</strong> ${start} - ${end}</p>
          </div>
          <div class="section-block">
            <div class="section-title">Участники</div>
            ${participantsHtml}
            <div class="mt-3 d-flex align-items-center">${joinButtonHtml}</div>
          </div>
        </div>
        ${data.description ? `<div class="section-block mt-3"><div class="section-title">Описание</div><p>${escapeHTML(data.description || '')}</p></div>` : ''}
        ${materialsHtml}
      `;

      (function(){
        function updateJoinBtnModal(){
          var btn = document.getElementById('joinLessonBtnModal');
          var info = document.getElementById('joinLessonInfoModal');
          if(!btn) return;
          var start = new Date(btn.getAttribute('data-start'));
          var end = new Date(btn.getAttribute('data-end'));
          var now = new Date();
          var windowOpen = new Date(start.getTime()-5*60000);
          if(now >= windowOpen && now <= end){
            btn.classList.remove('disabled');
            btn.setAttribute('href', btn.getAttribute('data-link'));
            btn.title = 'Присоединиться к занятию';
            if (info) info.textContent = '';
          }else{
            btn.classList.add('disabled');
            btn.setAttribute('href', '#');
            btn.title = 'Доступно за 5 минут до начала';
            if (info) info.textContent = '';
          }
        }
        updateJoinBtnModal();
        var interval = setInterval(updateJoinBtnModal, 60000);
        document.getElementById('lessonDetailsModal').addEventListener('hidden.bs.modal', function(){
          clearInterval(interval);
        });
      })();
    })
    .catch(err => {
      content.innerHTML = `<div class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle" style="font-size:2rem;"></i><div class="mt-2">${escapeHTML(err.detail || 'Ошибка загрузки данных занятия.')}</div></div>`;
    });
}
</script>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    var form = document.getElementById('lessons-filter-form');
    if(!form) return;
    var teacherSelect = form.querySelector('select[name="teacher"]');
    if(teacherSelect){
      teacherSelect.addEventListener('change', function(){
        try {
          var url = new URL(window.location.href);
          url.searchParams.delete('page');
          form.action = url.pathname;
        } catch(e) {}
        if(form.requestSubmit){ form.requestSubmit(); } else { form.submit(); }
      });
    }
  });
})();
</script>
{% endblock %}
