{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Мои занятия" %} - {% trans "Школа" %}{% endblock %}

{% block sidebar_admin_header %}{% endblock %}

{% block content %}
<style>
  .title-icon { height: 1em; width: auto; vertical-align: -0.12em; }
  .icon { height: 1em; width: auto; vertical-align: -0.15em; }
  .nav-pills .nav-link { border-radius: 10px; }
  .nav-pills .nav-link.active { box-shadow: 0 2px 8px rgba(13,110,253,.15); }
  .card { border: 1px solid #e7ecf3; border-radius: 14px; box-shadow: 0 4px 16px rgba(16,24,40,.06); }
  .card-header { background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%); border-bottom: 1px solid #e9edf5; }
  .table tbody tr:hover { background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); }
  .badge { vertical-align: middle; }
  .clickable-row { cursor: pointer; }
  .clickable-row .btn { cursor: default; }
  .filter-card .card-body { background: linear-gradient(180deg, #f8fafc 0%, #eef3f9 100%); border: 1px solid #e6ebf2; border-radius: 12px; }
  .filter-card .form-select { border-radius: 10px; border-color:#d7deea; }
  .filter-card .form-select:focus { border-color:#9bb7ff; box-shadow: 0 0 0 .2rem rgba(13,110,253,.12); }
  #lessonDetailsContent { line-height: 1.55; }
  #lessonDetailsContent p { margin-bottom: .5rem; }
  .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
  .section-block { background:#f8fafc; border:1px solid #e7ecf3; border-radius: 10px; padding: 12px 14px; }
  .section-title { font-weight: 600; margin-bottom: .5rem; }
  @media (max-width: 768px){ .details-grid { grid-template-columns: 1fr; } }

  .btn-outline-primary.btn-xs {
    transition: background 0.18s, color 0.18s;
    font-size: 0.9rem;
    border-radius: 6px;
    min-width: 28px;
    padding: 2px 8px;
    line-height: 1.2;
  }
  .btn-outline-primary.btn-xs:hover, .btn-outline-primary.btn-xs:focus {
    background: #0d6efd !important;
    color: #fff !important;
    border-color: #0d6efd !important;
  }
  .btn-outline-primary.btn-xs i { color: #0d6efd; font-size: 0.85rem; transition: color 0.18s; }
  .btn-outline-primary.btn-xs:hover i, .btn-outline-primary.btn-xs:focus i { color: #fff !important; }
  .btn-outline-danger.btn-xs {
    transition: background 0.18s, color 0.18s;
    font-size: 0.9rem; border-radius: 6px; min-width: 28px; padding: 2px 8px; line-height: 1.2;
    border-color: #dc3545; color: #dc3545; background: #fff;
  }
  .btn-outline-danger.btn-xs:hover, .btn-outline-danger.btn-xs:focus { background: #dc3545 !important; color: #fff !important; border-color: #dc3545 !important; }
  .btn-outline-danger.btn-xs i { color: #dc3545; font-size: 0.85rem; transition: color 0.18s; }
  .btn-outline-danger.btn-xs:hover i, .btn-outline-danger.btn-xs:focus i { color: #fff !important; }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">{% trans "Мои занятия" %}</h1>
</div>

<ul class="nav nav-pills mb-3">
  <li class="nav-item"><a class="nav-link {% if current_tab == 'upcoming' %}active{% endif %}" href="?tab=upcoming">{% trans "Предстоящие" %}</a></li>
  <li class="nav-item"><a class="nav-link {% if current_tab == 'all' %}active{% endif %}" href="?tab=all">{% trans "Завершенные" %}</a></li>
</ul>

<!-- Filters: teacher-specific version (нет фильтра 'Преподаватель') -->
<div class="card mb-3 filter-card">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-center" id="lessons-filter-form">
      <input type="hidden" name="tab" value="{{ current_tab|default:'upcoming' }}">
      <!-- Убрали фильтр по статусу; оставляем только поиск по имени ученика или названию -->
      <div class="col-12 col-md-8">
        <label class="form-label mb-1 small">{% trans "Поиск" %}</label>
        <div class="input-group input-group-sm">
          <input type="text" name="q" class="form-control" placeholder="Поиск по имени ученика или названию..." value="{{ current_filters.q }}" autocomplete="off" id="lesson-search-q" aria-label="Поиск по ученику или названию">
        </div>
      </div>
      <!-- Поля даты и кнопка отправки удалены: фильтрация происходит автоматически при изменении статуса или вводе в поиск -->
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">{% if current_tab == 'upcoming' %}{% trans "Предстоящие занятия" %}{% else %}{% trans "Завершенные занятия" %}{% endif %}</h5>
    <span class="badge bg-primary">{{ lessons|length }}</span>
  </div>
  <div class="card-body">
    {% if lessons %}
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>{% trans "Дата/Время" %}</th>
            <th>{% trans "Название" %}</th>
            <th>{% trans "Ученик" %}</th>
            <th>{% trans "Предмет" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for lesson in lessons %}
          <tr class="clickable-row" onclick="viewLessonDetails({{ lesson.pk }})">
            <td>
              <div class="fw-bold">{{ lesson.start_time|date:"d.m.Y" }}</div>
              <small class="text-muted">{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</small>
            </td>
            <td>
              <div class="fw-semibold">{{ lesson.title }}</div>
              <div class="text-muted small">{% if lesson.subject %}{{ lesson.subject.name }}{% endif %}</div>
            </td>
            <td>{{ lesson.student.full_name }}</td>
            <td>{{ lesson.subject.name }}</td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div id="lessons-not-found" class="text-center py-3 text-muted" style="display:none;">Ничего не найдено</div>
    </div>
    {% else %}
    <div class="text-center py-4">
      <img src="https://img.icons8.com/fluency/36/journal.png" class="mb-2" alt=""/>
      <div class="mt-2 text-muted">{% trans "Нет данных для отображения" %}</div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Lesson Details Modal -->
<div class="modal fade" id="lessonDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Информация о занятии</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Закрыть' %}"></button>
      </div>
      <div class="modal-body" id="lessonDetailsContent">
        <div class="text-center text-muted py-4">
          <div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Закрыть" %}</button>
      </div>
    </div>
  </div>
</div>

<script>
// Простая функция для экранирования HTML при вставке в innerHTML
function escapeHTML(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]; }); }

function viewLessonDetails(lessonId) {
  const modal = new bootstrap.Modal(document.getElementById('lessonDetailsModal'));
  const content = document.getElementById('lessonDetailsContent');
  content.innerHTML = '<div class="text-center text-muted py-4"><div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
  modal.show();

  fetch(`/scheduling/lessons/${lessonId}/details/`, { headers: { 'Accept': 'application/json' }})
    .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
    .then(data => {
      const title = escapeHTML(data.title || '');
      const subject = escapeHTML(data.subject || '');
      const date = escapeHTML(data.date || '');
      const start = escapeHTML(data.start_time || '');
      const end = escapeHTML(data.end_time || '');
      const zoom = data.zoom_link || '';
      const teacher = escapeHTML(data.teacher || '');
      const student = escapeHTML(data.student || '');
      const materials = data.materials || null;
      const teacherMaterials = data.teacher_materials || null;

      let participantsHtml = '';
      if (teacher) participantsHtml += `<p><strong>Преподаватель:</strong> ${teacher}</p>`;
      if (student) participantsHtml += `<p><strong>Ученик:</strong> ${student}</p>`;

      let materialsHtml = '';
      if (materials || teacherMaterials) {
        materialsHtml += '<div class="section-block mt-3"><div class="section-title">Материалы</div>';
        if (materials) {
          materialsHtml += `
            <div class="mb-2 d-flex align-items-center justify-content-between flex-wrap">
              <span>${escapeHTML(materials.name || '')}</span>
              <a href="${materials.url ? encodeURI(materials.url) : '#'}" class="btn btn-sm btn-outline-primary" download>Скачать</a>
              <div class="w-100 text-muted small mt-1">Общие материалы</div>
            </div>`;
        }
        if (teacherMaterials) {
          materialsHtml += `
            <div class="mb-2 d-flex align-items-center justify-content-between flex-wrap">
              <span>${escapeHTML(teacherMaterials.name || '')}</span>
              <a href="${teacherMaterials.url ? encodeURI(teacherMaterials.url) : '#'}" class="btn btn-sm btn-outline-warning" download>Скачать</a>
              <div class="w-100 text-muted small mt-1">Материалы для преподавателя</div>
            </div>`;
        }
        materialsHtml += '</div>';
      }

      let joinButtonHtml = '';
      if (zoom && data.start_iso && data.end_iso) {
        joinButtonHtml = `
          <a id="joinLessonBtnModal" class="btn btn-success disabled" href="#"
             data-start="${escapeHTML(data.start_iso)}" data-end="${escapeHTML(data.end_iso)}" data-link="${encodeURI(zoom)}" title="Доступно за 5 минут до начала">
            Подключиться к занятию
          </a>
          <span id="joinLessonInfoModal" class="text-muted ms-2" style="font-size:0.9em;"></span>`;
      }

      content.innerHTML = `
        <div class="details-grid">
          <div class="section-block">
            <div class="section-title">Основная информация</div>
            <p><strong>Название:</strong> ${title}</p>
            <p><strong>Предмет:</strong> ${subject}</p>
            <p><strong>Дата:</strong> ${date}</p>
            <p><strong>Время:</strong> ${start} - ${end}</p>
          </div>
          <div class="section-block">
            <div class="section-title">Участники</div>
            ${participantsHtml}
            <div class="mt-3 d-flex align-items-center">${joinButtonHtml}</div>
          </div>
        </div>
        ${data.description ? `<div class="section-block mt-3"><div class="section-title">Описание</div><p>${escapeHTML(data.description || '')}</p></div>` : ''}
        ${materialsHtml}
      `;

      (function(){
        function updateJoinBtnModal(){
          var btn = document.getElementById('joinLessonBtnModal');
          var info = document.getElementById('joinLessonInfoModal');
          if(!btn) return;
          var start = new Date(btn.getAttribute('data-start'));
          var end = new Date(btn.getAttribute('data-end'));
          var now = new Date();
          var windowOpen = new Date(start.getTime()-5*60000);
          if(now >= windowOpen && now <= end){
            btn.classList.remove('disabled');
            btn.setAttribute('href', btn.getAttribute('data-link'));
            btn.title = 'Присоединиться к занятию';
            if (info) info.textContent = '';
          }else{
            btn.classList.add('disabled');
            btn.setAttribute('href', '#');
            btn.title = 'Доступно за 5 минут до начала';
            if (info) info.textContent = '';
          }
        }
        updateJoinBtnModal();
        var interval = setInterval(updateJoinBtnModal, 60000);
        document.getElementById('lessonDetailsModal').addEventListener('hidden.bs.modal', function(){
          clearInterval(interval);
        });
      })();
    })
    .catch(err => {
      content.innerHTML = `<div class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle" style="font-size:2rem;"></i><div class="mt-2">${escapeHTML(err.detail || 'Ошибка загрузки данных занятия.')}</div></div>`;
    });
}

// Реализация мгновенного поиска по занятиям
const searchInput = document.getElementById('lesson-search-q');
if (searchInput) {
  searchInput.addEventListener('input', function() {
    const query = this.value.trim().toLowerCase();
    const table = this.closest('form').parentElement.parentElement.nextElementSibling.querySelector('table');
    const notFoundDiv = this.closest('form').parentElement.parentElement.nextElementSibling.querySelector('#lessons-not-found');
    if (!table) return;
    const rows = table.querySelectorAll('tbody tr');
    let visibleCount = 0;
    rows.forEach(row => {
      // Название занятия
      const titleCell = row.querySelector('td:nth-child(2) .fw-semibold');
      // Имя ученика
      const studentCell = row.querySelector('td:nth-child(3)');
      const title = titleCell ? titleCell.textContent.toLowerCase() : '';
      const student = studentCell ? studentCell.textContent.toLowerCase() : '';
      if (title.includes(query) || student.includes(query)) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });
    if (notFoundDiv) {
      notFoundDiv.style.display = (visibleCount === 0) ? '' : 'none';
    }
  });
}
</script>
{% endblock %}
