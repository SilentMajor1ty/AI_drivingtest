{% extends 'base.html' %}

{% block content %}
<h2>Детали занятия</h2>

<p><strong>Название:</strong> {{ lesson.title }}</p>
<p><strong>Предмет:</strong> {{ lesson.subject.name }}</p>
<p><strong>Преподаватель:</strong> {{ lesson.teacher.full_name }}</p>
<p><strong>Ученик:</strong> {{ lesson.student.full_name }}</p>
<p><strong>Время начала:</strong> {{ lesson.start_time }}</p>
<p><strong>Время окончания:</strong> {{ lesson.end_time }}</p>
<p><strong>Описание:</strong> {{ lesson.description }}</p>

<h3>Прикреплённые файлы</h3>
<ul>
    {% for file in lesson_files_all %}
    <li><a href="{{ file.file.url }}" download>{{ file.original_name }}</a></li>
    {% empty %}
    <li>Файлы отсутствуют.</li>
    {% endfor %}
</ul>

{% if lesson_files_teacher %}
<h3>Материалы преподавателя</h3>
<ul>
    {% for file in lesson_files_teacher %}
    <li><a href="{{ file.file.url }}" download>{{ file.original_name }}</a></li>
    {% endfor %}
</ul>
{% endif %}

{% if lesson.zoom_link %}
<div class="mt-3">
    <a id="joinLessonBtn" class="btn btn-success disabled" href="#" data-start="{{ lesson.start_time|date:'c' }}" data-end="{{ lesson.end_time|date:'c' }}" data-link="{{ lesson.zoom_link }}">
        <i class="bi bi-camera-video"></i> Присоединиться к занятию
    </a>
    <span id="joinLessonInfo" class="text-muted ms-2" style="font-size:0.9em;"></span>
</div>
<script>
(function(){
    function updateJoinBtn(){
        var btn = document.getElementById('joinLessonBtn');
        var info = document.getElementById('joinLessonInfo');
        if(!btn) return;
        var start = new Date(btn.getAttribute('data-start'));
        var end = new Date(btn.getAttribute('data-end'));
        var now = new Date();
        var windowOpen = new Date(start.getTime()-5*60000);
        if(now >= windowOpen && now <= end){
            btn.classList.remove('disabled');
            btn.setAttribute('href', btn.getAttribute('data-link'));
            btn.title = 'Присоединиться к занятию';
            info.textContent = '';
        } else {
            btn.classList.add('disabled');
            btn.removeAttribute('href');
            if(now < windowOpen){
                btn.title = 'Доступно за 5 минут до начала';
                info.textContent = 'Кнопка станет активной за 5 минут до начала.';
            } else {
                btn.title = 'Занятие завершено';
                info.textContent = 'Занятие завершено.';
            }
        }
    }
    updateJoinBtn();
    setInterval(updateJoinBtn, 30000);
})();
</script>
{% endif %}

{% if user.is_student %}
<div id="reportProblemSection"></div>
<script>
(function(){
    // Проверка времени: кнопка доступна если прошло 5 минут от старта
    var start = new Date("{{ lesson.start_time|date:'c' }}");
    var now = new Date();
    var windowOpen = new Date(start.getTime()+5*60000);
    var canReport = now >= windowOpen;
    var section = document.getElementById('reportProblemSection');
    if(canReport){
        section.innerHTML = `
        <button class="btn btn-danger mt-3" id="openReportModal">Пожаловаться на занятие</button>
        <div class="modal fade" id="reportProblemModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Пожаловаться на занятие</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Закрыть' %}"></button>
                    </div>
                    <div class="modal-body">
                        <form id="reportProblemForm">
                            <div class="mb-3">
                                <label for="problemType" class="form-label">Тип проблемы</label>
                                <select class="form-select" id="problemType" name="problem_type" required>
                                    <option value="tech">Техническая проблема</option>
                                    <option value="no_teacher">Учитель не пришёл</option>
                                    <option value="other">Другое</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="problemDesc" class="form-label">Описание</label>
                                <textarea class="form-control" id="problemDesc" name="description" rows="3" required></textarea>
                            </div>
                            <input type="hidden" name="lesson_id" value="{{ lesson.id }}">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-danger">Отправить жалобу</button>
                            </div>
                        </form>
                        <div id="reportSuccessMsg" class="alert alert-success mt-3 d-none">Жалоба отправлена!</div>
                        <div id="reportErrorMsg" class="alert alert-danger mt-3 d-none"></div>
                    </div>
                </div>
            </div>
        </div>
        `;
        var modal = new bootstrap.Modal(document.getElementById('reportProblemModal'));
        document.getElementById('openReportModal').onclick = function(){ modal.show(); };
        document.getElementById('reportProblemForm').onsubmit = function(e){
            e.preventDefault();
            var form = e.target;
            var fd = new FormData(form);
            fetch('/scheduling/report-problem/', {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value },
                body: fd
            }).then(r=>r.json()).then(data=>{
                if(data.success){
                    form.classList.add('d-none');
                    document.getElementById('reportSuccessMsg').classList.remove('d-none');
                    document.getElementById('openReportModal').disabled = true;
                }else{
                    document.getElementById('reportErrorMsg').textContent = data.error||'Ошибка отправки';
                    document.getElementById('reportErrorMsg').classList.remove('d-none');
                }
            }).catch(()=>{
                document.getElementById('reportErrorMsg').textContent = 'Ошибка отправки';
                document.getElementById('reportErrorMsg').classList.remove('d-none');
            });
        };
    }else{
        section.innerHTML = `<div class="alert alert-info mt-3">Жалоба доступна после начала занятия.</div>`;
    }
})();
</script>
{% endif %}

{% endblock %}
