{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Календарь" %} - {% trans "Школа" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-calendar3"></i> {% trans "Календарь" %}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if user.is_methodist %}
        <div class="btn-group me-2">
            <a href="{% url 'scheduling:lesson_create' %}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus"></i> {% trans "Запланировать занятие" %}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Calendar Navigation -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline-primary" onclick="previousMonth()">
                        <i class="bi bi-chevron-left"></i> Предыдущий месяц
                    </button>
                    <h4 id="currentMonthYear" class="mb-0"></h4>
                    <button class="btn btn-outline-primary" onclick="nextMonth()">
                        Следующий месяц <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <div class="row calendar-header">
                        <div class="col calendar-day-header">Пн</div>
                        <div class="col calendar-day-header">Вт</div>
                        <div class="col calendar-day-header">Ср</div>
                        <div class="col calendar-day-header">Чт</div>
                        <div class="col calendar-day-header">Пт</div>
                        <div class="col calendar-day-header">Сб</div>
                        <div class="col calendar-day-header">Вс</div>
                    </div>
                    <div id="calendarBody">
                        <!-- Calendar days will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lesson Details Modal -->
<div class="modal fade" id="lessonDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали занятий</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="lessonDetailsContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Problem Report Modal -->
<div class="modal fade" id="problemReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Сообщить о проблеме</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="problemReportForm">
                    {% csrf_token %}
                    <input type="hidden" id="reportLessonId" name="lesson_id">
                    <div class="mb-3">
                        <label for="problemType" class="form-label">Тип проблемы</label>
                        <select class="form-select" id="problemType" name="problem_type" required>
                            <option value="connection">Проблемы с подключением</option>
                            <option value="audio">Проблемы со звуком</option>
                            <option value="video">Проблемы с видео</option>
                            <option value="technical">Технические проблемы</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="problemDescription" class="form-label">Описание проблемы</label>
                        <textarea class="form-control" id="problemDescription" name="description" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="submitProblemReport()">Отправить</button>
            </div>
        </div>
    </div>
</div>

<!-- Lesson Completion Modal -->
<div class="modal fade" id="lessonCompletionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Оценить урок</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="completion-lesson-id">
                <div class="mb-3">
                    <label for="lesson-rating" class="form-label">Оценка урока (1-10)</label>
                    <select class="form-select" id="lesson-rating" required>
                        <option value="">Выберите оценку</option>
                        <option value="10">10 - Отлично</option>
                        <option value="9">9 - Очень хорошо</option>
                        <option value="8">8 - Хорошо</option>
                        <option value="7">7 - Неплохо</option>
                        <option value="6">6 - Удовлетворительно</option>
                        <option value="5">5 - Слабо</option>
                        <option value="4">4 - Плохо</option>
                        <option value="3">3 - Очень плохо</option>
                        <option value="2">2 - Ужасно</option>
                        <option value="1">1 - Кошмар</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="lesson-comments" class="form-label">Комментарий (необязательно)</label>
                    <textarea class="form-control" id="lesson-comments" rows="3" 
                              placeholder="Ваши впечатления о уроке..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitLessonCompletionWithRating()">
                    <i class="bi bi-check-circle"></i> Подтвердить и оценить
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-grid {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.calendar-day-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 10px;
    font-weight: bold;
    text-align: center;
}

.calendar-day {
    min-height: 120px;
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    padding: 5px;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s;
}

.calendar-day:hover {
    background-color: #f8f9fa;
}

.calendar-day.other-month {
    background-color: #f8f9fa;
    color: #6c757d;
}

.calendar-day.today {
    background-color: #e7f3ff;
    border: 2px solid #0d6efd;
}

.calendar-day.has-lessons {
    background-color: #d1ecf1;
}

.calendar-day-number {
    position: absolute;
    top: 5px;
    left: 8px;
    font-weight: bold;
    font-size: 14px;
}

.lesson-item {
    background-color: #0d6efd;
    color: white;
    padding: 2px 5px;
    margin: 2px 0;
    border-radius: 3px;
    font-size: 11px;
    cursor: pointer;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.lesson-item:hover {
    background-color: #0b5ed7;
}

.lesson-item.completed {
    background-color: #28a745;
}

.lesson-item.cancelled {
    background-color: #6c757d;
}

.lesson-time {
    font-weight: bold;
}

.lesson-subject {
    font-size: 10px;
    opacity: 0.9;
}

@media (max-width: 768px) {
    .calendar-day {
        min-height: 80px;
    }
    
    .lesson-item {
        font-size: 10px;
        padding: 1px 3px;
    }
    
    .calendar-day-number {
        font-size: 12px;
    }
}
</style>

<script>
let currentDate = new Date();
let lessonsData = [];

// Month names in Russian
const monthNames = [
    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
];

// Load lessons data from server
function loadLessons() {
    fetch(`/scheduling/api/calendar-lessons/?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`)
        .then(response => response.json())
        .then(data => {
            lessonsData = data.lessons;
            renderCalendar();
        })
        .catch(error => {
            console.error('Error loading lessons:', error);
            // Fallback: use server-rendered lessons data
            lessonsData = {{ lessons_json|safe }};
            renderCalendar();
        });
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update header
    document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    // Get the first Monday to start calendar (if month doesn't start on Monday)
    const startDate = new Date(firstDay);
    const dayOfWeek = (firstDay.getDay() + 6) % 7; // Convert to Monday = 0
    startDate.setDate(firstDay.getDate() - dayOfWeek);
    
    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = '';
    
    // Generate 6 weeks (42 days)
    for (let week = 0; week < 6; week++) {
        const weekRow = document.createElement('div');
        weekRow.className = 'row no-gutters';
        
        for (let day = 0; day < 7; day++) {
            const currentDay = new Date(startDate);
            currentDay.setDate(startDate.getDate() + (week * 7) + day);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'col calendar-day';
            
            // Check if day is in current month
            if (currentDay.getMonth() !== month) {
                dayElement.classList.add('other-month');
            }
            
            // Check if day is today
            const today = new Date();
            if (currentDay.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            }
            
            // Add day number
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = currentDay.getDate();
            dayElement.appendChild(dayNumber);
            
            // Find lessons for this day
            const dayLessons = lessonsData.filter(lesson => {
                const lessonDate = new Date(lesson.start_time);
                return lessonDate.toDateString() === currentDay.toDateString();
            });
            
            if (dayLessons.length > 0) {
                dayElement.classList.add('has-lessons');
                
                // Add lessons (max 3 visible)
                dayLessons.slice(0, 3).forEach(lesson => {
                    const lessonElement = document.createElement('div');
                    lessonElement.className = `lesson-item ${lesson.status}`;
                    
                    const lessonTime = new Date(lesson.start_time);
                    lessonElement.innerHTML = `
                        <div class="lesson-time">${lessonTime.getHours().toString().padStart(2, '0')}:${lessonTime.getMinutes().toString().padStart(2, '0')}</div>
                        <div class="lesson-subject">${lesson.subject}</div>
                    `;
                    
                    lessonElement.onclick = (e) => {
                        e.stopPropagation();
                        showLessonDetails(lesson.id);
                    };
                    
                    dayElement.appendChild(lessonElement);
                });
                
                // Show "more" indicator if there are more than 3 lessons
                if (dayLessons.length > 3) {
                    const moreElement = document.createElement('div');
                    moreElement.className = 'lesson-item';
                    moreElement.style.backgroundColor = '#6c757d';
                    moreElement.textContent = `+${dayLessons.length - 3} еще`;
                    moreElement.onclick = (e) => {
                        e.stopPropagation();
                        showDayLessons(currentDay, dayLessons);
                    };
                    dayElement.appendChild(moreElement);
                }
            }
            
            // Add click handler for day
            dayElement.onclick = () => showDayLessons(currentDay, dayLessons);
            
            weekRow.appendChild(dayElement);
        }
        
        calendarBody.appendChild(weekRow);
    }
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    loadLessons();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    loadLessons();
}

function showDayLessons(date, lessons) {
    const dateStr = date.toLocaleDateString('ru-RU', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    let content = `<h5>${dateStr}</h5>`;
    
    if (lessons.length === 0) {
        content += '<p class="text-muted">На этот день занятий не запланировано</p>';
    } else {
        content += '<div class="list-group">';
        lessons.forEach(lesson => {
            const startTime = new Date(lesson.start_time);
            const endTime = new Date(lesson.end_time);
            
            content += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${lesson.title}</h6>
                            <p class="mb-1"><strong>Предмет:</strong> ${lesson.subject}</p>
                            <p class="mb-1"><strong>Время:</strong> ${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} - ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}</p>
                            {% if user.is_student %}
                            <p class="mb-1"><strong>Преподаватель:</strong> ${lesson.teacher}</p>
                            {% elif user.is_teacher %}
                            <p class="mb-1"><strong>Ученик:</strong> ${lesson.student}</p>
                            {% else %}
                            <p class="mb-1"><strong>Преподаvatель:</strong> ${lesson.teacher}</p>
                            <p class="mb-1"><strong>Ученик:</strong> ${lesson.student}</p>
                            {% endif %}
                            ${lesson.description ? `<p class="mb-1"><strong>Описание:</strong> ${lesson.description}</p>` : ''}
                        </div>
                        <span class="badge bg-${lesson.status === 'completed' ? 'success' : lesson.status === 'scheduled' ? 'primary' : 'secondary'}">${lesson.status_display}</span>
                    </div>
                    ${lesson.zoom_link ? `
                    <div class="mt-2">
                        <a href="${lesson.zoom_link}" target="_blank" 
                           class="btn btn-sm btn-success me-2"
                           onclick="handleVideoCall(${lesson.id}, '${lesson.zoom_link}')">
                            <i class="bi bi-camera-video"></i> Подключиться
                        </a>
                    </div>` : ''}
                </div>
            `;
        });
        content += '</div>';
    }
    
    document.getElementById('lessonDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('lessonDetailsModal')).show();
}

function showLessonDetails(lessonId) {
    fetch(`/scheduling/lessons/${lessonId}/details/`)
        .then(response => response.json())
        .then(data => {
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Основная информация</h6>
                        <p><strong>Название:</strong> ${data.title}</p>
                        <p><strong>Предмет:</strong> ${data.subject}</p>
                        <p><strong>Дата:</strong> ${data.date}</p>
                        <p><strong>Время:</strong> ${data.start_time} - ${data.end_time}</p>
                        <p><strong>Статус:</strong> <span class="badge bg-primary">${data.status}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Участники</h6>
                        <p><strong>Преподаватель:</strong> ${data.teacher}</p>
                        <p><strong>Ученик:</strong> ${data.student}</p>
                        ${data.zoom_link ? `
                        <p><strong>Ссылка:</strong> 
                            <a href="${data.zoom_link}" target="_blank" 
                               class="btn btn-sm btn-success"
                               onclick="handleVideoCall(${lessonId}, '${data.zoom_link}')">
                                <i class="bi bi-camera-video"></i> Подключиться
                            </a>
                            {% if user.is_student %}
                            <button class="btn btn-sm btn-outline-warning ms-2"
                                    onclick="showProblemReport(${lessonId})">
                                <i class="bi bi-exclamation-triangle"></i> Сообщить о проблеме
                            </button>
                            {% endif %}
                        </p>` : ''}
                        
                        {% if user.is_teacher and data.teacher_materials %}
                        <p><strong>Материалы для преподавателя:</strong> 
                            <a href="${data.teacher_materials}" class="btn btn-sm btn-outline-info" target="_blank">
                                <i class="bi bi-download"></i> Скачать
                            </a>
                        </p>
                        {% endif %}
                    </div>
                </div>
                ${data.description ? `<div class="mt-3"><h6>Описание</h6><p>${data.description}</p></div>` : ''}
                
                <!-- Lesson completion buttons -->
                ${data.can_be_confirmed && !data.is_completed ? `
                    <div class="mt-3">
                        <h6>Подтверждение проведения урока</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="confirmLessonCompletion(${lessonId}, true)">
                                <i class="bi bi-check-circle"></i> Урок состоялся
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="showProblemReport(${lessonId})">
                                <i class="bi bi-exclamation-triangle"></i> Сообщить о проблеме
                            </button>
                        </div>
                    </div>
                ` : ''}
                
                ${data.is_completed ? `
                    <div class="mt-3">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Урок завершен и подтвержден
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('lessonDetailsContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('lessonDetailsModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при загрузке данных занятия');
        });
}

function handleVideoCall(lessonId, zoomLink) {
    window.open(zoomLink, '_blank');
    
    {% if user.is_student %}
    // For students, show problem report option after delay
    setTimeout(() => {
        if (confirm('Возникли проблемы с подключением к занятию?')) {
            showProblemReport(lessonId);
        }
    }, 5000);
    {% endif %}
}

function showProblemReport(lessonId) {
    document.getElementById('reportLessonId').value = lessonId;
    new bootstrap.Modal(document.getElementById('problemReportModal')).show();
}

function submitProblemReport() {
    const form = document.getElementById('problemReportForm');
    const formData = new FormData(form);
    
    fetch('/scheduling/report-problem/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Ваш отчет о проблеме отправлен методисту');
            bootstrap.Modal.getInstance(document.getElementById('problemReportModal')).hide();
            form.reset();
        } else {
            alert('Ошибка при отправке отчета: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при отправке отчета');
    });
}

function confirmLessonCompletion(lessonId, showRating = false) {
    if (showRating) {
        // Show rating modal
        document.getElementById('completion-lesson-id').value = lessonId;
        new bootstrap.Modal(document.getElementById('lessonCompletionModal')).show();
    } else {
        // Just confirm without rating
        submitLessonCompletion(lessonId);
    }
}

function submitLessonCompletion(lessonId, rating = null, comments = '') {
    const formData = new FormData();
    if (rating) formData.append('rating', rating);
    if (comments) formData.append('comments', comments);
    
    fetch(`/scheduling/lessons/${lessonId}/confirm-completion/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.is_completed) {
                alert('Урок успешно завершен и подтвержден!');
            } else {
                alert('Ваше подтверждение записано. Ожидается подтверждение от другой стороны.');
            }
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    });
}

function submitLessonCompletionWithRating() {
    const lessonId = document.getElementById('completion-lesson-id').value;
    const rating = document.getElementById('lesson-rating').value;
    const comments = document.getElementById('lesson-comments').value;
    
    submitLessonCompletion(lessonId, rating, comments);
}

// Initialize calendar on page load
document.addEventListener('DOMContentLoaded', function() {
    loadLessons();
});
</script>
{% endblock %}