{% extends 'base.html' %}
{% load i18n %}

{% block title %}Управление пользователями - {% trans "Школа" %}{% endblock %}

{% block content %}
<style>
  .avatar-32 { width:32px; height:32px; }
  /* Users page: make role text black for better readability */
  .users-role-badge { color: #000 !important; }
  /* Users page: slightly reduce action icons inside small button groups */
  .btn-group-sm .btn img { width: 16px; height: 16px; }
  /* Users page: align Role and Status columns */
  .table-users th:nth-child(4), .table-users td:nth-child(4),
  .table-users th:nth-child(5), .table-users td:nth-child(5) { text-align:center; vertical-align: middle; }
  .table-users .badge { vertical-align: middle; }

  /* Design polish */
  .filter-card .card-body { background: linear-gradient(180deg, #f8fafc 0%, #eef3f9 100%); border: 1px solid #e6ebf2; border-radius: 12px; }
  .filter-card .form-control, .filter-card .form-select { border-radius: 10px; border-color:#d7deea; }
  .filter-card .form-control:focus, .filter-card .form-select:focus { border-color:#9bb7ff; box-shadow: 0 0 0 .2rem rgba(13,110,253,.12); }
  .search-wrap { position: relative; }
  .search-wrap .search-icon { position:absolute; left: .6rem; top: 50%; transform: translateY(-50%); color:#94a3b8; }
  .search-wrap .search-input { padding-left: 2rem; }

  .card { border: 1px solid #e7ecf3; border-radius: 14px; box-shadow: 0 4px 16px rgba(16,24,40,.06); }
  .card-header { background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%); border-bottom: 1px solid #e9edf5; }
  .card-title { font-weight: 600; color: #1f2937; }

  .table-users tbody tr:hover { background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%); }
  .table-users td, .table-users th { vertical-align: middle; }

  .badge.bg-success i, .badge.bg-danger i { vertical-align: -1px; }

  .btn-outline-primary.btn-xs {
    transition: background 0.18s, color 0.18s;
  }
  .btn-outline-primary.btn-xs:hover, .btn-outline-primary.btn-xs:focus {
    background: #0d6efd !important;
    color: #fff !important;
    border-color: #0d6efd !important;
  }
  .btn-outline-primary.btn-xs:hover i, .btn-outline-primary.btn-xs:focus i {
    color: #fff !important;
  }
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Управление пользователями</h1>
    <!-- Кнопка 'Добавить' убрана -->
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center bg-white">
    <h5 class="mb-0">Пользователи</h5>
    <!-- Кнопка 'Добавить' убрана -->
  </div>
  <div class="card-body p-0">
    <!-- Фильтры -->
    <div class="filter-card card mb-3">
      <div class="card-body py-3">
        <form id="user-filter-form" method="get" class="row g-2 align-items-center mb-0">
          <div class="col-md-6 search-wrap">
            <span class="search-icon"><i class="bi bi-search"></i></span>
            <input type="text" name="q" class="form-control search-input" placeholder="Поиск по имени или логину..." value="{{ q }}" onchange="this.form.submit()" autocomplete="off">
          </div>
          <div class="col-md-4">
            <select name="role" class="form-select" onchange="this.form.submit()">
              <option value="">Все роли</option>
              {% for value, label in roles %}
                <option value="{{ value }}" {% if value == selected_role %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 table-users">
        <thead class="table-light">
          <tr>
            <th>Участник</th>
            <th>Логин</th>
            <th>Email</th>
            <th>Роль</th>
            <th>Статус</th>
            <th>Создан</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                {% if user.profile.avatar %}
                  <img src="{{ user.profile.avatar.url }}" class="rounded-circle shadow-sm me-2 avatar-32" alt="{{ user.full_name }}">
                {% else %}
                  <span class="me-2" style="display:inline-block;width:32px;height:32px;">
                    <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="#e0f2fe"></circle><text x="50%" y="55%" text-anchor="middle" fill="#0d6efd" font-size="16" font-family="Arial" dy=".3em">{{ user.first_name|slice:":1"|upper }}</text></svg>
                  </span>
                {% endif %}
                <div>
                  <div class="fw-bold">{{ user.full_name }}</div>
                  <div class="text-muted small">{{ user.get_role_display }}</div>
                </div>
              </div>
            </td>
            <td>{{ user.username }}</td>
            <td>{{ user.email|default:"—" }}</td>
            <td>{{ user.get_role_display }}</td>
            <td style="text-align:center;">
              {% if user.is_active %}
                <!-- Круглая галочка SVG уменьшенного размера -->
                <span title="Активен" style="display:inline-block;width:16px;height:16px;">
                  <svg viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="8" fill="#22c55e"/><path d="M4.5 8.5l2 2 4.5-4.5" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
              {% else %}
                <!-- Круглый крестик SVG уменьшенного размера -->
                <span title="Неактивен" style="display:inline-block;width:16px;height:16px;">
                  <svg viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="8" fill="#dc3545"/><path d="M5 5l6 6M11 5l-6 6" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg>
                </span>
              {% endif %}
            </td>
            <td class="text-muted small">{{ user.created_at|date:"d M Y" }}</td>
            <td>
              <a href="{% url 'accounts:user_edit' user.pk %}" class="btn btn-outline-primary btn-xs px-2 py-1" title="Редактировать" style="font-size:0.9rem;border-radius:6px;min-width:28px;">
                <i class="bi bi-pencil" style="color:#0d6efd;font-size:0.85rem;"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if is_paginated %}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1{% if selected_role %}&role={{ selected_role }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">Первая</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">Предыдущая</a>
            </li>
          {% endif %}
          <li class="page-item active">
            <span class="page-link">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
          </li>
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">Следующая</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">Последняя</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
    {% if not users %}
      <div class="text-center py-4">
        <img src="https://img.icons8.com/fluency/36/conference-call.png" class="mb-2" alt=""/>
        <h5 class="mt-1">Нет пользователей</h5>
        <p class="text-muted">
          <a href="{% url 'accounts:user_create' %}" class="btn btn-sm btn-primary"><i class="bi bi-plus-lg"></i> Создать нового пользователя</a>
        </p>
      </div>
    {% endif %}
  </div>
</div>

<script>
(function() {
  function debounce(fn, delay) {
    let t; return function() {
      const ctx = this, args = arguments;
      clearTimeout(t);
      t = setTimeout(function(){ fn.apply(ctx, args); }, delay);
    };
  }

  document.addEventListener('DOMContentLoaded', function(){
    const form = document.getElementById('user-filter-form');
    if (!form) return;

    const qInput = form.querySelector('input[name="q"]');
    const roleSelect = form.querySelector('select[name="role"]');

    const submitForm = () => {
      // Всегда начинаем с первой страницы
      try {
        const url = new URL(window.location.href);
        url.searchParams.delete('page');
        form.action = url.pathname; // не дублируем query
      } catch (e) { /* no-op */ }
      form.requestSubmit ? form.requestSubmit() : form.submit();
    };

    if (qInput) {
      qInput.addEventListener('input', debounce(submitForm, 400));
    }
    if (roleSelect) {
      roleSelect.addEventListener('change', submitForm);
    }
  });
})();
</script>
{% endblock %}